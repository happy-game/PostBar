<div class="markdown-text"><p><img src="https://user-images.githubusercontent.com/23253540/162456565-86fe05ac-757d-46fd-aad3-e344811c62cb.png" alt="image"></p>
<blockquote>
<p>æœ€è¿‘æ›´æ–‡è¾ƒå°‘, ä¸»è¦å¿™äºå„å¤§å›¢è´­ç¾¤ä¹°èœ + åšé¥­ + åšæ ¸é…¸ + è¿œç¨‹åŠå…¬ã€‚ä» 3æœˆ30å· åˆ°ä»Šå¤©å°åŒºå·²ç»å°äº† 11 å¤©, ä¸Šæµ·ç–«æƒ…åˆåˆ›äº†æ–°é«˜ 1015 + 22609 ä¾‹ã€‚åªå¸Œæœ›è¿™æ³¢ç–«æƒ…èµ¶ç´§ç»“æŸ, ä¸è¦å†å‡ºè´Ÿé¢æ–°é—»äº† ğŸ˜“ ã€‚å›¾ç‰‡æ¥è‡ªå°æ§å‰çš„ä¸€æ¬¡å›¤è´§å¤–å‡ºã€‚</p>
</blockquote>
<h2>èƒŒæ™¯</h2>
<p>è¿‘æœŸåœ¨å¯¹ SSR é¡¹ç›®è¿›è¡Œ <strong><em>CDNå’ŒåŸŸåç¾å¤‡</em></strong> çš„æ”¹é€ , åŒå­¦ a è´Ÿè´£çš„ Next.js é¡¹ç›®æ”¹é€ æµ‹è¯•æ—¶å‘ç° CDN æ²¡æœ‰é¢„æœŸå†…çš„åŠ¨æ€åˆ‡æ¢ã€‚è¿™ä¸ªé¡¹ç›®ä¸€ç›´æœ‰å†å²åŒ…è¢±, æˆ‘æƒ³ç€ä¸ä¼šçº¿ä¸Š Node ä¸€ç›´æ˜¯æŒ‚çš„å§,  éš¾é“é•¿ä¹…ä»¥æ¥éƒ½æ˜¯ Nginx è¿”å›çš„é™æ€å…œåº•é¡µé¢?</p>
<h2>é—®é¢˜æ’æŸ¥</h2>
<p>æœ¬åœ°å¯åŠ¨äº†è¯¥é¡¹ç›®, å‘ç°æ— è®ºæ˜¯æœåŠ¡ç«¯æ¸²æŸ“è¯·æ±‚è¿˜æ˜¯å¥åº·æ£€æŸ¥ Node æœåŠ¡éƒ½æ²¡æœ‰å¼‚å¸¸ã€‚å¾—å‡º Node å¤§æ¦‚ç‡æ˜¯ä¸€ç›´æ­£å¸¸è¿è¡Œçš„, é‚£ä¹ˆä¼šæ˜¯å…¶ä»–ä»€ä¹ˆåŸå› å¯¼è‡´çš„ä¸€ç›´è¿”å›çš„æ˜¯é™æ€èµ„æºè€Œéå®æ—¶çš„ SSR ç›´å‡ºäº†?</p>
<p>çœŸæ­£çš„åŸå› æ˜¯å½“ä½ çš„ src/pages/_app.tsx æ–‡ä»¶ä¸­å¯¼å‡ºçš„ App ç»„ä»¶æˆ–è€…æŸä¸ª Page ç»„ä»¶æ²¡æœ‰å®šä¹‰ getInitialProps æˆ–è€… getServerSideProps è¿™ä¸ªé™æ€æ–¹æ³•, æ„å‘³ç€ä½ å…¶å®æ˜¯ä¸éœ€è¦åœ¨æœåŠ¡ç«¯è¿›è¡Œæ³¨æ°´(æ¯”å¦‚æ‹‰å–ç”¨æˆ·çš„æŸä¸ªçœŸå®æ•°æ®æ¥å£, ç„¶åå®æ—¶æ¸²æŸ“ç›´å‡º)ã€‚</p>
<pre class="prettyprint language-js"><code>&#x2F;&#x2F; demo

function Page({ stars }) {
  return &lt;div&gt;Next stars: {stars}&lt;&#x2F;div&gt;
}

Page.getInitialProps = async (ctx) =&gt; {
  const res = await fetch(&#x27;https:&#x2F;&#x2F;api.github.com&#x2F;repos&#x2F;vercel&#x2F;next.js&#x27;)
  const json = await res.json()
  return { stars: json.stargazers_count }
}

export default Page
</code></pre><p>æ­¤æ—¶ Next.js ä¼šåœ¨æ‰“åŒ…æ„å»ºé˜¶æ®µé¢„æ¸²æŸ“ä¸€ä¸ªé™æ€ html, åˆ°é¡¹ç›®å‘å¸ƒæˆåŠŸ Node æœåŠ¡å¼€å§‹è¿è¡Œçš„æ—¶å€™ç›´æ¥è¿”å›è¯¥é™æ€ html å³å¯ã€‚å› ä¸ºä¸éœ€è¦æ³¨æ°´, html çš„æœ€ç»ˆå½¢æ€æ„å»ºæ—¶å°±èƒ½å†³å®šä¸‹æ¥äº†, æ²¡å¿…è¦æœåŠ¡ç«¯å†å®æ—¶æ¸²æŸ“, æ—¢èƒ½å‡å°‘ CPU æ¶ˆè€—åˆèƒ½éš¾ç¼©çŸ­ rtã€‚</p>
<p>åé¢æŸ¥é˜…äº†ä¸€ä¸‹æ–‡æ¡£, Next.js ç§°è¿™ä¸ªä¼˜åŒ–ç‚¹ä¸º <a href="https://nextjs.org/docs/advanced-features/automatic-static-optimization">Automatic Static Optimization</a>ã€‚</p>
<h2>ä»£ç å®ç°</h2>
<h3>æ„å»ºæ—¶</h3>
<p>å¯ä»¥çœ‹åˆ° isStatic çš„å€¼ä¸º true çš„æ¡ä»¶, å³å¯¼å‡ºçš„ App ç»„ä»¶æ²¡æœ‰å®šä¹‰ getStaticPropsã€ getInitialPropsã€getServerSideProps ä»»æ„ä¸€ä¸ªé™æ€æ–¹æ³•</p>
<pre class="prettyprint language-typescript"><code>&#x2F;&#x2F; packages&#x2F;next&#x2F;build&#x2F;utils.ts

export async function isPageStatic(
  &#x2F;&#x2F; ...
}&gt; {
  return isPageStaticSpan.traceAsyncFn(async () =&gt; {
    try {

      const mod = await loadComponents(distDir, page, serverless)
      const Comp = mod.Component

      const hasFlightData = !!(mod as any).__next_rsc__
      const hasGetInitialProps = !!(Comp as any).getInitialProps
      const hasStaticProps = !!mod.getStaticProps
      const hasStaticPaths = !!mod.getStaticPaths
      const hasServerProps = !!mod.getServerSideProps
    
      &#x2F;&#x2F; ...
        
      return {
        isStatic:
          !hasStaticProps &amp;&amp;
          !hasGetInitialProps &amp;&amp;
          !hasServerProps &amp;&amp;
          !hasFlightData,
        isHybridAmp: config.amp === &#x27;hybrid&#x27;,
        &#x2F;&#x2F; ...
      }
    } catch (err) {
      if (isError(err) &amp;&amp; err.code === &#x27;MODULE_NOT_FOUND&#x27;) return {}
      throw err
    }
  })
}
</code></pre><p>å¯¹äº isStatic çš„å€¼ä¸º true çš„é¡µé¢ (staticPages) å’Œå®šä¹‰äº† getStaticProps(ssgPages) é™æ€æ–¹æ³•çš„é¡µé¢å°±ä¼šé€šè¿‡ exportApp æ–¹æ³•è¿›è¡Œé¢„æ¸²æŸ“ç”Ÿæˆé™æ€ htmlã€‚</p>
<ul>
<li>exportApp çš„é¢„æ¸²æŸ“æ˜¯è°ƒç”¨çš„ ReactDOMServer.renderToString, å¹¶éæ˜¯å€ŸåŠ©çš„ puppeteer</li>
<li>next export å‘½ä»¤ä¹Ÿæ˜¯è°ƒç”¨çš„ exportApp æ–¹æ³•</li>
</ul>
<pre class="prettyprint language-typescript"><code>&#x2F;&#x2F; packages&#x2F;next&#x2F;build&#x2F;index.ts

export default async function build(
  dir: string,
  conf = null,
  reactProductionProfiling = false,
  debugOutput = false,
  runLint = true
): Promise&lt;void&gt; {
	&#x2F;&#x2F; ...

    const combinedPages = [...staticPages, ...ssgPages]

    if (combinedPages.length &gt; 0 || useStatic404 || useDefaultStatic500) {
      &#x2F;&#x2F; ...
        const exportApp: typeof import(&#x27;..&#x2F;export&#x27;).default =
          require(&#x27;..&#x2F;export&#x27;).default
        const exportOptions = {
          &#x2F;&#x2F; ...
        }
        const exportConfig: any = {
         &#x2F;&#x2F; ...
        }

        await exportApp(dir, exportOptions, nextBuildSpan, exportConfig)

        &#x2F;&#x2F; ...
}
</code></pre><p>æ„å»ºé˜¶æ®µç”Ÿæˆå¥½é™æ€çš„ html æ–‡ä»¶, æœåŠ¡è¿è¡Œæ—¶ç›´æ¥è¿”å›å³å¯</p>
<p><img src="https://user-images.githubusercontent.com/23253540/162478644-c40212d6-be39-4e67-9775-035d5d685985.png" alt="image"></p>
<p>å¯¹äºå®šä¹‰äº† getInitialProps æˆ–è€… getServerSideProps é™æ€æ–¹æ³•çš„ç»„ä»¶æ„å»ºé˜¶æ®µåˆ™åªä¼šç”ŸæˆæœåŠ¡ç«¯è¿è¡Œæ—¶éœ€è¦çš„ js æ–‡ä»¶
<img src="https://user-images.githubusercontent.com/23253540/162479210-273c9fa2-6930-4810-bfee-85c93547c3ce.png" alt="image"></p>
<h3>è¿è¡Œæ—¶</h3>
<p>å¦‚æœå‘ç°æ‰€éœ€ç»„ä»¶æ˜¯ä¸€ä¸ª html æ–‡ä»¶, requirePage æ–¹æ³•å°±ä¼šè¿”å›è¯¥ html çš„å­—ç¬¦ä¸²ã€‚å¦‚æœæ˜¯ä¸€ä¸ª js æ–‡ä»¶åˆ™æ­£å¸¸è¿”å›è¯¥æ¨¡å—çš„ module.exports, ç„¶åæœåŠ¡ç«¯æ¸²æŸ“è¯¥ç»„ä»¶ç”Ÿæˆ html å­—ç¬¦ä¸²</p>
<pre class="prettyprint language-typescript"><code>&#x2F;&#x2F; packages&#x2F;next&#x2F;server&#x2F;load-components.ts

export async function loadComponents(
  distDir: string,
  pathname: string,
  serverless: boolean,
  serverComponents?: boolean
): Promise&lt;LoadComponentsReturnType&gt; {
  if (serverless) {
    const ComponentMod = await requirePage(pathname, distDir, serverless)
    if (typeof ComponentMod === &#x27;string&#x27;) {
      return {
        Component: ComponentMod as any,
        pageConfig: {},
        ComponentMod,
      } as LoadComponentsReturnType
    }

    let {
      default: Component,
      getStaticProps,
      getStaticPaths,
      getServerSideProps,
    } = ComponentMod

    Component = await Component
    getStaticProps = await getStaticProps
    getStaticPaths = await getStaticPaths
    getServerSideProps = await getServerSideProps
    const pageConfig = (await ComponentMod.config) || {}

    return {
      Component,
      pageConfig,
      getStaticProps,
      getStaticPaths,
      getServerSideProps,
      ComponentMod,
    } as LoadComponentsReturnType
  }

  &#x2F;&#x2F; ...
}
</code></pre><p>ä»£ç çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬çŸ¥é“äº†</p>
<ul>
<li>getInitialProps å’Œ getServerSideProps æ˜¯æœåŠ¡ç«¯æ¸²æŸ“æ—¶æ‰ä¼šè¿è¡Œçš„ç”¨äºæ³¨æ°´çš„é’©å­å‡½æ•°, Next.js æ¨èä½¿ç”¨ getServerSideProps å‡½æ•°</li>
<li>getStaticProps æ˜¯æ„å»ºæ—¶æ‰ä¼šè¿è¡Œçš„ç”¨äºæ³¨æ°´çš„é’©å­å‡½æ•°</li>
</ul>
<h3>å¦‚ä½•åŒºåˆ†</h3>
<p>é€šè¿‡ä¸‹é¢çš„ä»£ç å¯ä»¥çœ‹è§å¯ä»¥é€šè¿‡ Next.js æ³¨å…¥çš„ <strong>NEXT_DATA</strong> çš„ gsp, gssp, gip ç­‰å€¼å³å¯ä»¥å¿«é€Ÿåˆ¤æ–­å½“å‰é¡µé¢æ˜¯ä½•ç§æ–¹å¼è¿›è¡Œçš„æ¸²æŸ“æ–¹å¼</p>
<pre class="prettyprint language-typescript"><code>&#x2F;&#x2F; packages&#x2F;next&#x2F;server&#x2F;render.tsx

export async function renderToHTML(
  req: IncomingMessage,
  res: ServerResponse,
  pathname: string,
  query: NextParsedUrlQuery,
  renderOpts: RenderOpts
): Promise&lt;RenderResult | null&gt; {
  &#x2F;&#x2F; ...
  
  const htmlProps: HtmlProps = {
    __NEXT_DATA__: {
      props, &#x2F;&#x2F; The result of getInitialProps
      nextExport: nextExport === true ? true : undefined, &#x2F;&#x2F; If this is a page exported by &#96;next export&#96;
      autoExport: isAutoExport === true ? true : undefined, &#x2F;&#x2F; If this is an auto exported page
      gsp: !!getStaticProps ? true : undefined, &#x2F;&#x2F; whether the page is getStaticProps
      gssp: !!getServerSideProps ? true : undefined, &#x2F;&#x2F; whether the page is getServerSideProps
      rsc: isServerComponent ? true : undefined, &#x2F;&#x2F; whether the page is a server components page
      customServer, &#x2F;&#x2F; whether the user is using a custom server
      gip: hasPageGetInitialProps ? true : undefined, &#x2F;&#x2F; whether the page has getInitialProps
      appGip: !defaultAppGetInitialProps ? true : undefined, &#x2F;&#x2F; whether the _app has getInitialProps
      &#x2F;&#x2F; ...
    },
  }

  &#x2F;&#x2F; ...

  return new RenderResult(chainStreams(streams))
}
</code></pre><p>çŸ¥é“å¦‚ä½•åŒºåˆ†åå›å¤´çœ‹çœ‹è¯¥é¡¹ç›®è¿”å›çš„ html å°±å¯ä»¥å¿«é€ŸçŸ¥é“è¯¥é¡µé¢æ˜¯æ²¡æœ‰å®šä¹‰ getStaticPropsã€getInitialPropsã€getServerSideProps ä»»æ„ä¸€ä¸ªé™æ€æ–¹æ³•çš„å³ isStatic ä¸º true çš„é™æ€é¡µé¢
<img src="https://user-images.githubusercontent.com/23253540/162563683-6ff27dde-b153-480a-87fe-6ebd21ae9469.png" alt="image"></p>
<h2>å°ç»“</h2>
<p>ç”±äºæ²¡æœ‰å®šä¹‰ getInitialPropsã€getServerSideProps ä»»æ„ä¸€ä¸ªé™æ€æ–¹æ³•æ•… Node å®æ—¶çš„è·å– CDN é…ç½®ä¿¡æ¯ä»¥åŠæ¸²æŸ“çš„é€»è¾‘æ²¡æœ‰è¿è¡Œ, è¯¥é¡µé¢çš„è¯·æ±‚éƒ½æ˜¯ Node ç›´æ¥è¿”å›çš„é™æ€ htmlã€‚</p>
<p>åŸæ–‡é“¾æ¥: <a href="https://github.com/xiaoxiaojx/blog/issues/34">https://github.com/xiaoxiaojx/blog/issues/34</a></p>
</div>