<div class="markdown-text"><p><img src="https://user-images.githubusercontent.com/23253540/158014929-cefd5457-8452-4064-8d8b-f3486f1baedc.png" alt="images">
åŸæ–‡åœ°å€: <a href="https://github.com/xiaoxiaojx/blog/issues/33">https://github.com/xiaoxiaojx/blog/issues/33</a></p>
<h2>èƒŒæ™¯</h2>
<p>æœåŠ¡ç«¯æ¸²æŸ“çš„é¡¹ç›®æœ¬åœ°æ¨¡æ‹Ÿçº¿ä¸Šç¯å¢ƒè¿è¡ŒæŠ¥äº†å¦‚ä¸‹çš„ä¸€ä¸ªé”™è¯¯ï¼Œç„¶è€Œæœ¬åœ°å¼€å‘æ¨¡å¼è¿è¡Œå’ŒçœŸå®çš„çº¿ä¸Šç”Ÿäº§æ¨¡å¼è¿è¡Œå‡æ²¡æœ‰é—®é¢˜ã€‚å½“å¬åˆ°è¿™ä¸ªé—®é¢˜æè¿°æ—¶ï¼Œæˆ‘åªè§‰å¾—è¿™ä¸ªä¸´åºŠè¡¨ç°é€éœ²ç€è¯¡å¼‚çš„æ°›å›´ ğŸ˜¢</p>
<blockquote>
<p>æœ¬åœ°æ¨¡æ‹Ÿçº¿ä¸Šç¯å¢ƒæ˜¯å…ˆæ„å»ºå‡ºç”Ÿäº§æ¨¡å¼çš„ä»£ç ï¼Œç„¶åè¿è¡Œ SSR Server ã€‚å…¶ç›®çš„æ˜¯æ›´æ¥è¿‘çœŸå®çš„çº¿ä¸Šç”Ÿäº§ç¯å¢ƒçš„æ•ˆæœ, é€šå¸¸ç”¨äºå¤ç°ä¸ debug çº¿ä¸Šç¯å¢ƒå‡ºç°çš„é—®é¢˜ã€‚</p>
</blockquote>
<pre class="prettyprint language-html"><code>&#x2F;&#x2F; é”™è¯¯ä¿¡æ¯

Invariant Violation: You should not use &lt;Switch&gt; outside a &lt;Router&gt;
</code></pre><h2>é—®é¢˜ç®€è¿°</h2>
<p>ä¸Šé¢çš„é”™è¯¯ä¿¡æ¯é€ æˆåŸå› é€šå¸¸æœ‰ä¸¤ä¸ª</p>
<ol>
<li>Switch ç»„ä»¶çš„ä¸Šå±‚æ²¡æœ‰ Router ç»„ä»¶ï¼Œè§£å†³åŠæ³•æ˜¯ä½¿ç”¨åŸºäº Router ç»„ä»¶çš„ BrowserRouter ç»„ä»¶æˆ– HashRouter ç»„ä»¶ä½œä¸º Switch çš„çˆ¶ç»„ä»¶</li>
</ol>
<blockquote>
<p>æœåŠ¡ç«¯è¿è¡Œä½¿ç”¨çš„å…¶å®æ˜¯ StaticRouter, æœåŠ¡ç«¯æ¸²æŸ“çš„æ˜¯ä¸€ä¸ªè¯·æ±‚ path çš„é¡µé¢å¿«ç…§, ä¸å­˜åœ¨å®¢æˆ·ç«¯è·¯ç”±ä¼šåˆ‡æ¢çš„æƒ…å†µ</p>
</blockquote>
<ol>
<li>node_modules ä¸­ react-router æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œè§£å†³åŠæ³•æ˜¯æ”¶æ‹¢ä¾èµ–ï¼Œåªèƒ½å…è®¸ä¸€ä¸ªç‰ˆæœ¬</li>
</ol>
<blockquote>
<p>å¦‚æœ react-router æœ‰å¤šä¸ªç‰ˆæœ¬, ä½¿ç”¨ Router ç»„ä»¶çš„ RouterContext ä¸ä½¿ç”¨ Switch ç»„ä»¶çš„ RouterContext å°†ä¼šæ˜¯åœ¨ä¸¤ä¸ªç‰ˆæœ¬çš„æ–‡ä»¶ä¸­ï¼Œé€ æˆ RouterContext ä¸æ˜¯åŒä¸€ä¸ªå¼•ç”¨ï¼Œå¹³æ—¶è¿™ä¸€ç‚¹è¾ƒéš¾å‘ç°</p>
</blockquote>
<p>ç†Ÿæ‚‰ React çš„åŒå­¦åº”è¯¥çŸ¥é“, å­ç»„ä»¶è¦èƒ½ä» RouterContext.Consumer ä¸­è·å–åˆ°çˆ¶ç»„ä»¶ RouterContext.Provider æ³¨å…¥çš„æ•°æ®ï¼Œ å…¶ RouterContext å¿…é¡»æ˜¯åŒä¸€ä¸ªå¯¹è±¡æ‰è¡Œ</p>
<p>å¦‚ä¸‹ react-router çš„ä»£ç , è¯´æ˜äº† Switch ç»„ä»¶æ˜¯éœ€è¦ä» Router ç»„ä»¶è·å–å¿…è¦çš„ context ä¿¡æ¯, context ä¸å­˜åœ¨åˆ™æŠ›é”™</p>
<pre class="prettyprint language-js"><code>&#x2F;&#x2F; react-router

class Router extends React.Component {

  render() {
    return (
      &lt;RouterContext.Provider
        value={{
          history: this.props.history,
          location: this.state.location,
          match: Router.computeRootMatch(this.state.location.pathname),
          staticContext: this.props.staticContext
        }}
      &gt;
        &lt;HistoryContext.Provider
          children={this.props.children || null}
          value={this.props.history}
        &#x2F;&gt;
      &lt;&#x2F;RouterContext.Provider&gt;
    );
  }
}

class Switch extends React.Component {
  render() {
    return (
      &lt;RouterContext.Consumer&gt;
        {context =&gt; {
          &#x2F;&#x2F; æŠ›é”™å¤„ ğŸ‘‡
          invariant(context, &quot;You should not use &lt;Switch&gt; outside a &lt;Router&gt;&quot;);

          const location = this.props.location || context.location;

          let element, match;

          &#x2F;&#x2F; We use React.Children.forEach instead of React.Children.toArray().find()
          &#x2F;&#x2F; here because toArray adds keys to all child elements and we do not want
          &#x2F;&#x2F; to trigger an unmount&#x2F;remount for two &lt;Route&gt;s that render the same
          &#x2F;&#x2F; component at different URLs.
          React.Children.forEach(this.props.children, child =&gt; {
            if (match == null &amp;&amp; React.isValidElement(child)) {
              element = child;

              const path = child.props.path || child.props.from;

              match = path
                ? matchPath(location.pathname, { ...child.props, path })
                : context.match;
            }
          });

          return match
            ? React.cloneElement(element, { location, computedMatch: match })
            : null;
        }}
      &lt;&#x2F;RouterContext.Consumer&gt;
    );
  }
}
</code></pre><h2>é—®é¢˜æ’æŸ¥</h2>
<h3>1. ç¡®è®¤ RouterContext æ˜¯åŒä¸€ä¸ªå¼•ç”¨</h3>
<p>ä» yarn.lock æ–‡ä»¶çœ‹å‡º react-router ç¡®å®åªæœ‰ä¸€ä¸ªç‰ˆæœ¬ï¼Œä¸è¿‡ä»ç„¶å­˜åœ¨ node_modules æ–‡ä»¶ç¼“å­˜æ²¡æœ‰åˆ é™¤æˆåŠŸï¼Œå¯¼è‡´æ®‹ç•™äº†æ—§ç‰ˆæœ¬çš„å¯èƒ½æ€§ã€‚æ­¤æ—¶æˆ‘ä»¬éœ€è¦åˆ†åˆ«åœ¨ Router å’Œ Switch render æ—¶åŠ ä¸Š debugger, ç¡®è®¤ä»£ç è¿è¡Œæ—¶ RouterContext.Provider ä¸ RouterContext.Consumer æ˜¯åŒä¸€ä¸ª RouterContext å¼•ç”¨</p>
<p>é€šè¿‡ debugger æ–­ç‚¹ä¹Ÿç¡®è®¤äº† RouterContext æ˜¯åŒä¸€ä¸ªå¼•ç”¨, é‚£ä¹ˆå­ç»„ä»¶é€šè¿‡ Consumer ä»ç„¶æ‹¿ä¸åˆ° context å²‚ä¸æ˜¯ React çš„ bug ?</p>
<pre class="prettyprint language-js"><code>&#x2F;&#x2F; react-router

class Switch extends React.Component {
  render() {
    return (
      &lt;RouterContext.Consumer&gt;
        {context =&gt; {
          &#x2F;&#x2F; æŠ›é”™å¤„ ğŸ‘‡
          invariant(context, &quot;You should not use &lt;Switch&gt; outside a &lt;Router&gt;&quot;);

		  &#x2F;&#x2F; ...
      &lt;&#x2F;RouterContext.Consumer&gt;
    );
  }
}
</code></pre><h3>2. React çš„ bug ?</h3>
<p>æ­¤æ—¶æˆ‘ä»¬è¿˜ä¸èƒ½ç¡®è®¤æ˜¯ React çš„ bug, è¦å…ˆæ‘†è„± react-router çš„å«Œç–‘ã€‚å†™äº†å¦‚ä¸‹çš„ demo, å‘ç° console.log ä¾ç„¶æ²¡æœ‰å€¼ï¼Œä¸è¿‡æŠŠ demo å¤åˆ¶åˆ°ç›¸åŒ react ç‰ˆæœ¬çš„å¦ä¸€ä¸ª SSR é¡¹ç›®ä¸­ console.log æ˜¯æœ‰å€¼çš„ï¼Œå¾—å‡ºä¸æ˜¯ React çš„ bug</p>
<pre class="prettyprint language-js"><code>import React from &#x27;react&#x27;

const MyRouterContext = React.createContext({})

function App() {
  return (
    &lt;MyRouterContext.Provider value={{ test: 1 }}&gt;
      &lt;MyRouterContext.Consumer&gt;
        {(ctx) =&gt; {
          console.log(ctx)
          return 11111
        }}
      &lt;&#x2F;MyRouterContext.Consumer&gt;
    &lt;&#x2F;MyRouterContext.Provider&gt;
  )
}
</code></pre><p>æ’æŸ¥äº†ä¸€åœˆä¸‹æ¥å‘ç°å¤§å®¶éƒ½æ˜¯è¢«å†¤æ‰çš„ ğŸ˜¢</p>
<ul>
<li>react å’Œ react-router æ²¡æœ‰é—®é¢˜</li>
<li>æœ¬åœ°å¼€å‘æ¨¡å¼è¿è¡Œå’ŒçœŸå®çš„çº¿ä¸Šç”Ÿäº§æ¨¡å¼è¿è¡Œä¹Ÿæ²¡æœ‰é—®é¢˜</li>
</ul>
<h3>3. å¯¹æ¯”å…³é”®ä¿¡æ¯çš„å¼‚åŒ</h3>
<p>æœ€ååªèƒ½å’Œæ­£å¸¸èƒ½è¿è¡Œçš„ SSR é¡¹ç›®æ¥è¿›è¡Œä¸åŒäº†ï¼Œæ’æŸ¥é‡ç‚¹åœ¨äº</p>
<ol>
<li>package.json ä¸­çš„ä¾èµ–</li>
<li>è„šæ‰‹æ¶é…ç½®æ–‡ä»¶çš„é…ç½®ä¿¡æ¯</li>
</ol>
<p>åœ¨ä¸€é˜µå¯¹æ¯”å, è¿˜æ˜¯å‘ç°äº†å…³é”®çš„ä¿¡æ¯ã€‚æœ¬åœ°æ¨¡æ‹Ÿçº¿ä¸Šç¯å¢ƒè¿è¡Œçš„æ˜¯ä¸‹é¢çš„å‘½ä»¤</p>
<blockquote>
<p>æ¨¡æ‹Ÿçº¿ä¸Š NODE_ENV æœ€å¥½æ˜¯åº”è¯¥è®¾ç½®æˆ production, è¿™é‡Œå´è®¾ç½®æˆäº† development</p>
</blockquote>
<pre class="prettyprint language-json"><code>    &quot;co-start&quot;: &quot;yarn build &amp;&amp; NODE_ENV=development DOCKER=true yarn start&quot;
</code></pre><p>ç”Ÿäº§ç¯å¢ƒ yarn build æ‰“åŒ…åï¼Œä»£ç å¼€å§‹æŒ‰å¦‚ä¸‹é¡ºåºè¿è¡Œ</p>
<ol>
<li>è¯»å–è„šæ‰‹æ¶é…ç½®æ–‡ä»¶çš„é…ç½®ä¿¡æ¯</li>
<li>åˆ›å»º SSR Server å®ä¾‹
<ul>
<li>ä¸€äº›åˆå§‹åŒ–æ“ä½œ, ç”Ÿäº§æ¨¡å¼è¿è¡Œä¼šå¼ºåˆ¶åˆå§‹åŒ– NODE_ENV ä¸º production</li>
<li>åˆ›å»ºå®ä¾‹, å¼€å§‹ç›‘å¬ç«¯å£</li>
</ul>
</li>
</ol>
<p>åœ¨æ­¥éª¤1ä¸­, NODE_ENV æ˜¯ co-start å‘½ä»¤è®¾ç½®çš„ development, è¯¥é…ç½®æ–‡ä»¶ import äº†ä¸€ä¸ªåŒ… packageA, packageA ä¸‹æŸä¸ªåŒ…åˆ import äº† react , æ‰€ä»¥æ­¤æ—¶ Node.js ç¼“å­˜ä½äº† react  æ¨¡å—, å…¶å€¼ä¸º development ç¯å¢ƒçš„ ./cjs/react.development.js çš„æ¨¡å—å¯¼å‡º</p>
<pre class="prettyprint"><code>&#x2F;&#x2F; react&#x2F;index.js

&#x27;use strict&#x27;;

if (process.env.NODE_ENV === &#x27;production&#x27;) {
  module.exports = require(&#x27;.&#x2F;cjs&#x2F;react.production.min.js&#x27;);
} else {
  module.exports = require(&#x27;.&#x2F;cjs&#x2F;react.development.js&#x27;);
}
</code></pre><p>åœ¨æ­¥éª¤ 2 ä¸­, åˆ¤æ–­æ­¤æ—¶æ˜¯ç”Ÿäº§æ¨¡å¼è¿è¡Œå°±å¼ºåˆ¶åˆå§‹åŒ– NODE_ENV ä¸º production, ä½¿å¾—åé¢è¿è¡Œçš„ import { renderToString } from â€˜react-dom/serverâ€™ éƒ¨åˆ†çš„ä»£ç , react-dom çš„å€¼ä¸º production ç¯å¢ƒä¸‹ ./cjs/react-dom-server.node.production.min.js çš„æ¨¡å—å¯¼å‡º</p>
<p><strong><em>react å’Œ react-dom ä¸€ä¸ªä½¿ç”¨çš„æ˜¯å¼€å‘ç‰ˆæœ¬, ä¸€ä¸ªä½¿ç”¨çš„æ˜¯ç”Ÿäº§ç‰ˆæœ¬</em></strong></p>
<p>æ­¤æ—¶æˆ‘ä»¬ç¯¡æ”¹ node_modules ä¸­ react-dom ä¸ react çš„ä»£ç , ç»Ÿä¸€æ›¿æ¢ process.env.NODE_ENV === â€˜productionâ€™ ä¸º true æˆ–è€… false, ä½¿å¾— react-dom ä¸ react å¼•ç”¨ç¯å¢ƒä¿æŒä¸€è‡´, å‘ç°ä¸€åˆ‡å°±èƒ½æ­£å¸¸è¿è¡Œäº† âœ…</p>
<pre class="prettyprint"><code>&#x2F;&#x2F; react-dom&#x2F;server.node.js

&#x27;use strict&#x27;;

if (process.env.NODE_ENV === &#x27;production&#x27;) {
  module.exports = require(&#x27;.&#x2F;cjs&#x2F;react-dom-server.node.production.min.js&#x27;);
} else {
  module.exports = require(&#x27;.&#x2F;cjs&#x2F;react-dom-server.node.development.js&#x27;);
}
</code></pre><h2>å°ç»“</h2>
<blockquote>
<p>ç‰ˆæœ¬ä¿¡æ¯: react@16.14.0 react-dom@16.14.0 node@12.20.1</p>
</blockquote>
<p>è¿è¡Œ react ä¸ react-dom æ—¶çš„ process.env.NODE_ENV çš„å€¼ä¸ä¸€è‡´å°†ä¼šå¯¼è‡´æœåŠ¡ç«¯æ¸²æŸ“æ—¶ Consumer ç»„ä»¶æ‹¿ä¸åˆ° Provider ç»„ä»¶é€ä¼ ä¸‹æ¥çš„ Context</p>
</div>